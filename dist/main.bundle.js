!function(){"use strict";var s=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},e=function(){function s(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}return function(t,e,i){return e&&s(t.prototype,e),i&&s(t,i),t}}(),i="td_list",o="td_status",n=function(){function t(){s(this,t),this.todos=[],this.handlers={}}return e(t,[{key:"on",value:function(t,e){this.handlers[t]=e}},{key:"trigger",value:function(t){this.handlers[t]&&this.handlers[t]()}},{key:"getAll",value:function(){return[].concat(this.todos)}},{key:"getItemById",value:function(e){return this.todos.find(function(t){return t.id===e})}},{key:"getInfo",value:function(){return{total:this.todos.length,completed:this.todos.filter(function(t){return!!t.completed}).length}}},{key:"getStorageStatus",value:function(){var t=localStorage.getItem(o);return t?JSON.parse(t):{lastTS:-1}}},{key:"addItem",value:function(t){this.todos=this.todos.concat(t),this.save()}},{key:"updateItem",value:function(e,i){this.todos=this.todos.map(function(t){return t.id===e?Object.assign(t,i):t}),this.save()}},{key:"toggleItem",value:function(e){this.todos=this.todos.map(function(t){return t.id===e&&(t.completed=!t.completed),t}),this.save()}},{key:"removeItem",value:function(e){this.todos=this.todos.filter(function(t){return t.id!==e}),this.save()}},{key:"load",value:function(){return this.todos=JSON.parse(localStorage.getItem(i)||"[]"),Promise.resolve()}},{key:"save",value:function(){try{localStorage.setItem(i,JSON.stringify(this.todos)),localStorage.setItem(o,JSON.stringify({lastTS:Date.now()})),this.trigger("saved")}catch(t){this.trigger("error")}}}]),t}();function t(n){var r=1<arguments.length&&void 0!==arguments[1]&&arguments[1],a=arguments[2];return function(t,e){var i=t[n],s=e[n],o=void 0;return a&&(i=a(i),s=a(s)),o=i<s?-1:s<i?1:0,r?-o:o}}function r(t){var e=t.closest("[data-id]");if(!e)return null;var i=e.getAttribute("data-id");return parseInt(i,10)}function a(t){var e=t.completed?"todo-item--completed":"";return'<li class="todo-list__item" data-id="'+t.id+'">\n    <span class="todo-item '+e+'" data-action="toggle">\n      <span class="todo-item__text">\n        <span class="todo-item__title">'+t.title+'</span>\n      </span>\n      <span class="todo-item__controls">\n        <button class="todo-btn todo-btn--transparent" data-action="edit">\n          Edit\n        </button>\n        <button class="todo-btn todo-btn--lg todo-btn--transparent" data-action="remove">\n          &times;\n        </button>\n      </span>\n    </span>\n  </li>'}var d=t("title",!1,function(t){return t.toLowerCase()}),u=t("title",!0,function(t){return t.toLowerCase()});new(function(){function i(t){var e=this;s(this,i),this.todos=new n,this.sortOrderActive=!1,this.sortOrderDirect=!0,this.editFinished=!1,this.inputEl=t.querySelector(".js-todo-input"),this.todoList=t.querySelector(".js-todo-list"),this.counterEl=t.querySelector(".js-todo-count"),this.statusEl=t.querySelector(".js-todo-status"),this.sortBtn=t.querySelector(".js-todo-btn-sort"),this._bindListeners(),this.todos.on("saved",this._renderStorageStatus.bind(this,"success")),this.todos.on("error",this._renderStorageStatus.bind(this,"error")),this.todos.load().then(function(){e._render(),e._renderStorageStatus("success")})}return e(i,[{key:"_bindListeners",value:function(){this.inputEl.addEventListener("change",this._inputHandler.bind(this)),this.todoList.addEventListener("click",this._listClickHandler.bind(this)),this.sortBtn.addEventListener("click",this._sortClickHandler.bind(this))}},{key:"_inputHandler",value:function(t){var e=t.target.value;e=e.trim(),t.target.value="",this.todos.addItem({id:Math.floor(1e6*Math.random()),title:e,completed:!1}),this._render()}},{key:"_listClickHandler",value:function(t){var e=!1,i=t.target,s=i.closest("[data-action]"),o=r(i);if(s&&o){switch(s.getAttribute("data-action")){case"toggle":this.todos.toggleItem(o),e=!0;break;case"remove":this.todos.removeItem(o),e=!0;break;case"edit":this._startEdit(o)}e&&this._render()}}},{key:"_sortClickHandler",value:function(t){this.sortOrderActive&&(this.sortOrderDirect=!this.sortOrderDirect),this.sortOrderActive=!0,this._render()}},{key:"_startEdit",value:function(t){var e=this.todoList.querySelector('[data-id="'+t+'"]'),i=this.todos.getItemById(t);if(e&&i){var s=this._cacheEditInput();s.value=i.title,e.appendChild(s),s.focus(),this.editFinished=!1}}},{key:"_finishEdit",value:function(t){var e=r(t.target);if(e){var i=t.target.value;""===i.trim()?this.todos.removeItem(e):this.todos.updateItem(e,{title:i})}this.editFinished=!0,this._removeEditInput(),this._render()}},{key:"_cancelEdit",value:function(){this._removeEditInput()}},{key:"_cacheEditInput",value:function(){var e=this;if(!this.editInput){var t=document.createElement("input");t.className="todo-list__input",t.addEventListener("keyup",function(t){switch(t.keyCode){case 13:e._finishEdit(t);break;case 27:t.target.blur()}}),t.addEventListener("blur",function(t){e._cancelEdit()}),this.editInput=t}return this.editInput}},{key:"_removeEditInput",value:function(){this.editFinished||this.editInput.parentNode&&this.editInput.parentNode.removeChild(this.editInput)}},{key:"_render",value:function(){var t=this.todos.getAll();this.sortOrderActive&&t.sort(this.sortOrderDirect?d:u),this.todoList.innerHTML=t.map(a).join(""),this._renderFooter()}},{key:"_renderFooter",value:function(){var t;this.counterEl.innerHTML="Completed: "+(t=this.todos.getInfo()).completed+" / Total: "+t.total,this.sortOrderActive&&this.sortBtn.classList.remove("todo-btn--inactive"),this.sortBtn.innerText=this.sortOrderActive?this.sortOrderDirect?"A-Z":"Z-A":"Sort"}},{key:"_renderStorageStatus",value:function(t){var e,i=this.todos.getStorageStatus().lastTS;this.statusEl.classList.toggle("todo-footer__status--success","success"===t),this.statusEl.classList.toggle("todo-footer__status--error","error"===t),this.statusEl.innerText="Storage "+t+" | Last saved: "+((e=i)<0?"Never":new Date(e).toLocaleString())}}]),i}())(document.querySelector(".js-todo-app"))}();
